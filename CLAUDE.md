# ERP System - Claude Code Configuration

**Project**: Multi-tenant Fuel Station ERP  
**Company**: Kakebe Technologies, Lira, Uganda  
**Team**: Backend (Django/PostgreSQL) + Frontend (Next.js)  
**Stack**: Django 5.0/DRF, PostgreSQL 16, Redis, Next.js 14, TypeScript, Docker

**Current Phase**: Authentication & User Management  
**Status**: âœ… Auth working | ğŸš§ Dashboard + Users | â³ Next: POS

---

## Project Structure

```
erp/
â”œâ”€â”€ backend/                # Django REST API
â”‚   â”œâ”€â”€ config/            # Settings, URLs
â”‚   â”œâ”€â”€ users/             # User management (models, views, serializers, permissions)
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ frontend/              # Next.js App
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ login/        # Public
â”‚   â”‚   â””â”€â”€ (dashboard)/  # Protected layout group
â”‚   â”‚       â””â”€â”€ dashboard/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ layout/       # Sidebar, Topbar
â”‚   â”‚   â”œâ”€â”€ ui/           # shadcn/ui
â”‚   â”‚   â””â”€â”€ [feature]/    # Feature components
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ api.ts        # API client
â”‚   â”‚   â”œâ”€â”€ store/        # Zustand stores
â”‚   â”‚   â””â”€â”€ hooks/        # TanStack Query hooks
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env                   # NOT in Git
â”œâ”€â”€ .env.example           # Template (in Git)
â””â”€â”€ Claude.md             # This file
```

---

## Daily Workflow

**Morning**
```bash
git pull origin main
docker-compose up
# Check #dev channel, review Miro board
```

**During Development**
- Work on Miro tasks
- Commit frequently: `feat: add user search endpoint`
- Push when testable
- Tag teammate if blocked

**End of Day**
```bash
git push
# Update Miro status
# Post in #dev: "Built X, stuck on Y, tomorrow Z"
docker-compose down  # optional
```

### Git Workflow
- `main` - stable only
- `backend-feature` / `frontend-feature` - work branches
- Small changes â†’ merge to main
- Large features â†’ PR + quick review

**Commit Format**: `type: description`  
Types: `feat`, `fix`, `refactor`, `docs`, `test`

---

## Docker Commands

```bash
# Daily
docker-compose up              # Start all
docker-compose up -d           # Background
docker-compose logs -f backend # View logs
docker-compose ps              # Check status
docker-compose down            # Stop all

# After dependency changes
docker-compose build backend
docker-compose build frontend

# Django commands
docker-compose exec backend python manage.py migrate
docker-compose exec backend python manage.py makemigrations
docker-compose exec backend python manage.py createsuperuser
docker-compose exec backend python manage.py test
docker-compose exec backend python manage.py shell

# Database access
docker-compose exec db psql -U nexus_user -d nexus_db

# Nuclear option (deletes DB)
docker-compose down -v
```

---

## Backend Standards (Django)

### Model Template
```python
class MyModel(models.Model):
    # Required fields first
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    
    # Always include timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['-created_at']
    
    def __str__(self):
        return self.name
```

### ViewSet Template
```python
class MyViewSet(viewsets.ModelViewSet):
    queryset = MyModel.objects.all()
    serializer_class = MySerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['name']
    
    def get_serializer_class(self):
        if self.action == 'create':
            return MyCreateSerializer
        return MySerializer
    
    @action(detail=True, methods=['post'])
    def custom_action(self, request, pk=None):
        obj = self.get_object()
        return Response({'status': 'success'})
```

### API Response Format
```python
# List (paginated)
{"count": 100, "next": "...", "previous": null, "results": [...]}

# Single object
{"id": 1, "name": "...", "created_at": "2026-02-12T10:00:00Z"}

# Error
{"error": "Clear message", "detail": "Context"}
```

### Testing
```python
from rest_framework.test import APITestCase

class UserAPITest(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(email='test@x.com', password='pass')
        self.client.force_authenticate(user=self.user)
    
    def test_list_users(self):
        response = self.client.get('/api/users/')
        self.assertEqual(response.status_code, 200)
```

---

## Frontend Standards (Next.js)

### Component Patterns

**Server Component (default)**
```typescript
// Static content, layouts
export default function UsersPage() {
  return <div><h1>Users</h1><UsersList /></div>;
}
```

**Client Component (interactive)**
```typescript
'use client';
import { useState } from 'react';

export function UsersList() {
  const [search, setSearch] = useState('');
  // interactive logic
}
```

### API Hooks (TanStack Query)
```typescript
// lib/hooks/useUsers.ts
export function useUsers(search = '') {
  return useQuery({
    queryKey: ['users', search],
    queryFn: () => apiClient(`/users/?search=${search}`),
  });
}

export function useCreateUser() {
  const queryClient = useQueryClient();
  return useMutation({
    mutationFn: (data) => apiClient('/users/', {
      method: 'POST',
      body: JSON.stringify(data),
    }),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['users'] }),
  });
}
```

### TypeScript
```typescript
interface User {
  id: number;
  email: string;
  first_name: string;
  last_name: string;
  role: 'admin' | 'manager' | 'cashier' | 'attendant' | 'accountant';
  is_active: boolean;
  created_at: string;
}

interface UserTableProps {
  users: User[];
  onEdit: (user: User) => void;
}

export function UserTable({ users, onEdit }: UserTableProps) {
  // ...
}
```

### State Management
- **API data**: TanStack Query (caching, refetching)
- **Auth**: Zustand with localStorage persistence
- **UI state**: React useState
- **Forms**: react-hook-form

### Styling
- Tailwind utility classes only (no custom CSS)
- shadcn/ui for components
- Mobile-first: design for 375px, scale up

---

## API Reference

### Authentication
```
POST   /api/auth/login/      â†’ { access, refresh }
POST   /api/auth/refresh/    â†’ { access }
GET    /api/auth/me/         â†’ User object (requires auth)
```

### Users
```
GET    /api/users/                    â†’ List (paginated, searchable)
POST   /api/users/                    â†’ Create (admin/manager)
GET    /api/users/{id}/               â†’ Retrieve
PATCH  /api/users/{id}/               â†’ Update (admin/manager)
POST   /api/users/{id}/deactivate/   â†’ Deactivate (admin only)
POST   /api/users/{id}/activate/     â†’ Activate (admin only)

Query params: ?search=john&ordering=-created_at
```

### Authentication Flow
1. Login â†’ receive `{ access, refresh }`
2. Store in Zustand (localStorage)
3. All requests: `Authorization: Bearer {access}`
4. On 401 â†’ refresh token or redirect to login

**CORS**: Backend allows `http://localhost:3000`

---

## Module Implementation Pattern

Every new feature follows this workflow:

**Backend**
1. `python manage.py startapp module_name`
2. Define models â†’ serializers â†’ ViewSets â†’ permissions
3. Wire URLs, run migrations
4. Write tests, test with curl

**Frontend**
1. Create route: `app/(dashboard)/dashboard/module/page.tsx`
2. Create hooks: `lib/hooks/useModule.ts`
3. Build components: `components/module/`
4. Add to Sidebar navigation
5. Test in browser

**Integration**
- CRUD from frontend works
- Permissions correct
- Search/filter functional
- Mobile responsive

---

## Common Issues

### Port already in use
```bash
lsof -ti:8000 | xargs kill -9
# Or change port in docker-compose.yml: "8001:8000"
```

### Database connection refused
```bash
docker-compose ps          # Check DB running
docker-compose restart db
# Ensure settings.py has HOST='db' not 'localhost'
```

### CORS errors
- Check `django-cors-headers` installed
- Verify `CORS_ALLOWED_ORIGINS = ["http://localhost:3000"]`
- Confirm `corsheaders.middleware.CorsMiddleware` in MIDDLEWARE

### Token expired
- Access tokens: 1 hour (configurable)
- Handle 401 by refreshing or redirecting to login

### Changes not showing
```bash
docker-compose build backend  # After dependency changes
# Code changes sync via volumes automatically
```

---

## Performance

**Backend**
- Use `select_related()` / `prefetch_related()` to avoid N+1
- Add indexes on frequently queried fields
- Enable query logging in dev
- Use Redis for caching

**Frontend**
- TanStack Query handles caching
- Lazy load heavy components
- Debounce search inputs
- Paginate large lists

---

## Security

**Backend**
- Never commit `.env`
- Environment variables for secrets
- Validate all inputs
- Permission classes on ViewSets
- `DEBUG=False` in production

**Frontend**
- Validate forms (but don't trust it)
- Sanitize user inputs before display
- Handle 401 gracefully
- Never log sensitive data

---

## Working with Claude Code

### Prompting
**Good**: "Create DRF ViewSet for Products with fields: name, sku, price. Add search by name/sku. Follow backend standards from Claude.md"

**Bad**: "make me a product thing"

### File References
Use exact paths: `backend/users/views.py`, `frontend/app/(dashboard)/dashboard/users/page.tsx`

### Code Review
"Review this for Django best practices, security (SQL injection/XSS), N+1 queries, and type safety"

---

## Team Communication

**Shared Claude Account**
- Post in #dev before starting Claude Code session
- Keep sessions under 30 minutes when possible
- Share snippets if blocked

**Code Conflicts**
- Pull before starting work
- Communicate which files you're touching
- Resolve conflicts immediately

**Knowledge Sharing**
- Update this Claude.md with new patterns
- Update Miro board as tasks complete
- EOD message with progress/blockers

---

## Quick Reference

### Settings
- `AUTH_USER_MODEL = 'users.User'`
- JWT access: 1 hour, refresh: 7 days
- Pagination: 20 items/page
- Timestamps: UTC

### File Organization
**Backend**: `app_name/` â†’ `models.py`, `serializers.py`, `views.py`, `urls.py`, `permissions.py`, `tests.py`

**Frontend**: `app/` (routes), `components/` (UI), `lib/` (logic)

### Resources
- Django: https://docs.djangoproject.com/
- DRF: https://www.django-rest-framework.org/
- Next.js: https://nextjs.org/docs
- TanStack Query: https://tanstack.com/query/latest
- shadcn/ui: https://ui.shadcn.com/

---

**Last Updated**: February 2026  
**Current Phase**: 2 - Authentication & User Management  
**Next Phase**: 3 - POS & Sales Module
